---
# Molecule конфигурация для роли system-update
# Использует образы из проекта docker-systemd

dependency:
  name: galaxy
  enabled: false  # Отключено для локального тестирования (роль используется локально)
  options:
    ignore-errors: true

driver:
  name: podman

platforms:
  - name: instance-debian-bookworm
    image: docker.io/ykossin/docker-systemd:debian-bookworm
    pre_build_image: true
    privileged: true
    cgroupns_mode: host
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    tmpfs:
      - /tmp
      - /run
      - /run/lock
    command: /lib/systemd/systemd
    groups:
      - debian_family
      - debian_bookworm
    # Переменные для тестирования
    environment:
      container: podman
      DEBIAN_FRONTEND: noninteractive

  - name: instance-debian-bullseye
    image: docker.io/ykossin/docker-systemd:debian-bullseye
    pre_build_image: true
    privileged: true
    cgroupns_mode: host
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    tmpfs:
      - /tmp
      - /run
      - /run/lock
    command: /lib/systemd/systemd
    groups:
      - debian_family
      - debian_bullseye
    environment:
      container: podman
      DEBIAN_FRONTEND: noninteractive

  - name: instance-ubuntu-22.04
    image: docker.io/ykossin/docker-systemd:ubuntu-22.04
    pre_build_image: true
    privileged: true
    cgroupns_mode: host
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    tmpfs:
      - /tmp
      - /run
      - /run/lock
    command: /lib/systemd/systemd
    groups:
      - debian_family
      - ubuntu
      - ubuntu_22.04
    environment:
      container: podman
      DEBIAN_FRONTEND: noninteractive

  - name: instance-ubuntu-24.04
    image: docker.io/ykossin/docker-systemd:ubuntu-24.04
    pre_build_image: true
    privileged: true
    cgroupns_mode: host
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    tmpfs:
      - /tmp
      - /run
      - /run/lock
    command: /lib/systemd/systemd
    groups:
      - debian_family
      - ubuntu
      - ubuntu_24.04
    environment:
      container: podman
      DEBIAN_FRONTEND: noninteractive

  # Ubuntu 20.04 исключен из тестов - Python 3.8 не поддерживается Ansible 2.20+
  # - name: instance-ubuntu-20.04
  #   image: docker.io/ykossin/docker-systemd:ubuntu-20.04
  #   pre_build_image: true
  #   privileged: true
  #   cgroupns_mode: host
  #   volumes:
  #     - /sys/fs/cgroup:/sys/fs/cgroup:rw
  #   tmpfs:
  #     - /tmp
  #     - /run
  #     - /run/lock
  #   command: /lib/systemd/systemd
  #   groups:
  #     - debian_family
  #     - ubuntu
  #     - ubuntu_20.04
  #   environment:
  #     container: podman
  #     DEBIAN_FRONTEND: noninteractive

provisioner:
  name: ansible
  config_options:
    defaults:
      # Увеличиваем таймаут для systemd
      timeout: 30
      # Отключаем host key checking для тестов
      host_key_checking: false
      # Интерпретатор Python
      interpreter_python: auto_silent
      # Путь к ролям (для локального использования)
      roles_path: ../../..
  inventory:
    host_vars:
      instance-debian-bookworm:
        ansible_python_interpreter: /usr/bin/python3
      instance-debian-bullseye:
        ansible_python_interpreter: /usr/bin/python3
      instance-ubuntu-22.04:
        ansible_python_interpreter: /usr/bin/python3
      instance-ubuntu-24.04:
        ansible_python_interpreter: /usr/bin/python3
  playbooks:
    converge: ${MOLECULE_PLAYBOOK:-converge.yml}
    prepare: prepare.yml

lint: |
  set -e
  yamllint .
  ansible-lint --skip-list role-name

verifier:
  name: ansible
  # Можно пропустить проверку systemd в контейнерах, раскомментировав следующую строку:
  # options:
  #   skip-tags: verify:systemd
