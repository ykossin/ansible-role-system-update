# План тестирования роли system-update

**Дата создания:** январь 2026  
**Роль:** system-update  
**Тестовый фреймворк:** Molecule + Docker

---

## Цели тестирования

1. Проверить корректность работы роли на разных дистрибутивах
2. Убедиться, что все улучшения работают правильно
3. Проверить обработку ошибок
4. Проверить создание логов
5. Проверить проверки безопасности (место, репозитории, версия)

---

## Платформы для тестирования

### Основные платформы (обязательные)
- ✅ Debian 12 (bookworm) - последняя стабильная версия
- ✅ Debian 11 (bullseye) - предыдущая стабильная версия
- ✅ Ubuntu 22.04 LTS - долгосрочная поддержка
- ✅ Ubuntu 20.04 LTS - предыдущая LTS версия

### Дополнительные платформы (опционально)
- ⏸️ Debian 10 (buster) - EOL, но может быть в продакшене
- ⏸️ Ubuntu 24.04 LTS - новая версия

---

## Сценарии тестирования

### Сценарий 1: Базовое обновление системы
**Цель:** Проверить базовую функциональность обновления

**Шаги:**
1. Создать контейнер с чистой системой
2. Применить роль с базовыми настройками
3. Проверить обновление списка пакетов
4. Проверить обновление пакетов
5. Проверить отсутствие ошибок

**Ожидаемый результат:**
- ✅ Список пакетов обновлен
- ✅ Пакеты обновлены (если есть обновления)
- ✅ Нет ошибок в логах
- ✅ Система работает стабильно

**Команда:**
```bash
molecule converge -- --limit instance-debian-bookworm
molecule verify -- --limit instance-debian-bookworm
```

---

### Сценарий 2: Проверка предварительных проверок
**Цель:** Убедиться, что все проверки работают

**Проверки:**
1. ✅ Проверка версии дистрибутива
2. ✅ Проверка свободного места на диске
3. ✅ Проверка доступности репозиториев
4. ✅ Проверка целостности пакетов после обновления

**Ожидаемый результат:**
- ✅ Все проверки проходят успешно
- ✅ Информация отображается корректно
- ✅ Предупреждения показываются при необходимости

**Команда:**
```bash
molecule converge
molecule verify
```

---

### Сценарий 3: Обработка ошибок
**Цель:** Проверить обработку ошибок при обновлении

**Шаги:**
1. Симулировать ошибку обновления (опционально)
2. Проверить автоматическое исправление
3. Проверить повторную попытку обновления

**Ожидаемый результат:**
- ✅ Ошибки обрабатываются корректно
- ✅ Автоматическое исправление работает
- ✅ Система остается в рабочем состоянии

**Команда:**
```bash
# Тест с включенным автоисправлением
molecule converge
```

---

### Сценарий 4: Логирование
**Цель:** Проверить создание и содержимое логов

**Проверки:**
1. ✅ Создание директории для логов
2. ✅ Создание файла лога обновления
3. ✅ Содержимое лога (дата, список пакетов)
4. ✅ Формат лога

**Ожидаемый результат:**
- ✅ Директория `/var/log/ansible` создана
- ✅ Файл лога создан с правильным именем
- ✅ Лог содержит информацию об обновлении
- ✅ Лог читаемый и структурированный

**Команда:**
```bash
molecule converge
molecule verify
# Проверить логи внутри контейнера
molecule login -h instance-debian-bookworm
# cat /var/log/ansible/system-update-*.log
```

---

### Сценарий 5: Информация об обновлениях
**Цель:** Проверить отображение информации об обновлениях

**Проверки:**
1. ✅ Количество обновляемых пакетов
2. ✅ Список обновляемых пакетов
3. ✅ Информация о свободном месте

**Ожидаемый результат:**
- ✅ Информация отображается корректно
- ✅ Количество пакетов подсчитано правильно
- ✅ Список пакетов читаемый

**Команда:**
```bash
molecule converge
```

---

### Сценарий 6: Обновление только безопасности
**Цель:** Проверить обновление только security пакетов

**Шаги:**
1. Настроить роль для обновления только безопасности
2. Применить роль
3. Проверить, что обновлены только security пакеты

**Ожидаемый результат:**
- ✅ Обновлены только security пакеты
- ✅ Обычные пакеты не обновлены

**Команда:**
```bash
# Отредактировать converge.yml: system_security_only: true
molecule converge
```

---

### Сценарий 7: Автоматические обновления (unattended-upgrades)
**Цель:** Проверить настройку автоматических обновлений

**Проверки:**
1. ✅ Установка unattended-upgrades
2. ✅ Создание конфигурационного файла
3. ✅ Правильность конфигурации
4. ✅ Запуск сервиса

**Ожидаемый результат:**
- ✅ unattended-upgrades установлен
- ✅ Конфигурация создана правильно
- ✅ Сервис запущен

**Команда:**
```bash
# Отредактировать converge.yml: system_unattended_upgrades: true
molecule converge
molecule verify
```

---

### Сценарий 8: Тестирование на всех платформах
**Цель:** Убедиться, что роль работает на всех поддерживаемых платформах

**Платформы:**
- Debian 12 (bookworm)
- Debian 11 (bullseye)
- Ubuntu 22.04
- Ubuntu 20.04

**Ожидаемый результат:**
- ✅ Роль работает на всех платформах
- ✅ Нет ошибок на любой платформе
- ✅ Все проверки проходят

**Команда:**
```bash
molecule test
```

---

## Критерии успешного тестирования

### Обязательные критерии (должны пройти все)
1. ✅ Роль применяется без ошибок на всех платформах
2. ✅ Все предварительные проверки работают
3. ✅ Логи создаются корректно
4. ✅ Целостность пакетов проверяется
5. ✅ Зависимости apt проверяются
6. ✅ Systemd работает после применения роли
7. ✅ Репозитории доступны

### Желательные критерии (желательно пройти)
1. ⭐ Обновления применяются корректно
2. ⭐ Информация об обновлениях отображается
3. ⭐ Автоматические обновления настраиваются

---

## Порядок выполнения тестов

### Этап 1: Подготовка (5 минут)
1. Проверить наличие образов docker-systemd
2. Проверить установку Molecule
3. Проверить доступность Docker

### Этап 2: Базовое тестирование (10 минут)
1. Запустить тесты на одной платформе (Debian 12)
2. Проверить результаты
3. Исправить критические ошибки, если есть

### Этап 3: Полное тестирование (20 минут)
1. Запустить тесты на всех платформах
2. Проверить все сценарии
3. Проверить логи

### Этап 4: Дополнительное тестирование (10 минут)
1. Тестирование обработки ошибок
2. Тестирование автоматических обновлений
3. Тестирование обновления только безопасности

### Этап 5: Анализ результатов (5 минут)
1. Собрать результаты тестов
2. Проанализировать ошибки
3. Создать отчет

**Общее время:** ~50 минут

---

## Команды для выполнения

### Быстрый тест (одна платформа)
```bash
cd /home/kossin/OVR/jobs/kch/bindki-io/exchanger-iac/ansible/roles/system-update
molecule test -- --limit instance-debian-bookworm
```

### Полный тест (все платформы)
```bash
cd /home/kossin/OVR/jobs/kch/bindki-io/exchanger-iac/ansible/roles/system-update
molecule test
```

### Пошаговое выполнение
```bash
# 1. Создать контейнеры
molecule create

# 2. Подготовить окружение
molecule prepare

# 3. Применить роль
molecule converge

# 4. Проверить результаты
molecule verify

# 5. Удалить контейнеры
molecule destroy
```

---

## Ожидаемые результаты

### Успешный тест
- Все контейнеры создаются успешно
- Роль применяется без ошибок
- Все проверки проходят
- Логи создаются корректно
- Systemd работает стабильно

### Возможные проблемы и решения

#### Проблема: Образы не найдены
**Решение:** Собрать образы docker-systemd
```bash
cd /home/kossin/OVR/jobs/me/docker-systemd
make build DISTR=debian VERSION=bookworm
```

#### Проблема: Systemd не запускается
**Решение:** Проверить параметры в molecule.yml (privileged, cgroupns_mode)

#### Проблема: Таймаут при подключении
**Решение:** Увеличить timeout в molecule.yml

#### Проблема: Ошибки обновления пакетов
**Решение:** Проверить доступность репозиториев, проверить интернет-соединение

---

## Отчет о тестировании

После выполнения тестов будет создан отчет с:
- ✅ Список выполненных тестов
- ✅ Результаты на каждой платформе
- ✅ Найденные проблемы
- ✅ Рекомендации по улучшению

---

**Последнее обновление:** январь 2026
