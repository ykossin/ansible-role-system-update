---
# Основные задачи для обновления системы

# ============================================
# ПРЕДВАРИТЕЛЬНЫЕ ПРОВЕРКИ
# ============================================

- name: Проверка версии дистрибутива
  fail:
    msg: "Неподдерживаемая версия {{ ansible_distribution }} {{ ansible_distribution_version }}. Требуется минимум {{ system_min_distribution_version }}"
  when:
    - system_check_distribution_version
    - ansible_distribution not in ['Debian', 'Ubuntu']
  tags:
    - update
    - system
    - check

- name: Проверка минимальной версии дистрибутива (Debian)
  fail:
    msg: "Требуется минимум Debian {{ system_min_distribution_version }}, установлена {{ ansible_distribution_version }}"
  when:
    - system_check_distribution_version
    - ansible_distribution == "Debian"
    - ansible_distribution_version | int < (system_min_distribution_version | int)
  tags:
    - update
    - system
    - check

- name: Проверка минимальной версии дистрибутива (Ubuntu)
  fail:
    msg: "Требуется минимум Ubuntu {{ system_min_distribution_version }}, установлена {{ ansible_distribution_version }}"
  when:
    - system_check_distribution_version
    - ansible_distribution == "Ubuntu"
    - ansible_distribution_version | version_compare(system_min_distribution_version, '<')
  tags:
    - update
    - system
    - check

- name: Проверка свободного места на диске
  stat:
    path: /
  register: root_fs
  tags:
    - update
    - system
    - check

- name: Получение информации о свободном месте (GB)
  shell: df -BG / | tail -1 | awk '{print $4}' | sed 's/G//'
  register: free_space_gb
  changed_when: false
  tags:
    - update
    - system
    - check

- name: Проверка достаточности свободного места
  fail:
    msg: "Недостаточно свободного места на диске. Требуется минимум {{ system_min_free_space_gb }}GB, доступно {{ free_space_gb.stdout }}GB"
  when:
    - system_update_enabled
    - (free_space_gb.stdout | int) < (system_min_free_space_gb | int)
  tags:
    - update
    - system
    - check

- name: Отображение информации о свободном месте
  debug:
    msg: "Свободно места на диске: {{ free_space_gb.stdout }}GB (требуется минимум {{ system_min_free_space_gb }}GB)"
  when: system_show_upgrade_info
  tags:
    - update
    - system
    - check

- name: Проверка доступности основных репозиториев
  uri:
    url: "{{ item }}"
    method: HEAD
    status_code: [200, 301, 302, 403]
    timeout: 10
  loop:
    - "http://deb.debian.org/debian/"
    - "http://security.debian.org/"
  register: repo_check
  failed_when: false
  changed_when: false
  when:
    - system_check_repositories
    - ansible_distribution == "Debian"
  tags:
    - update
    - system
    - check

- name: Предупреждение о недоступных репозиториях
  debug:
    msg: "⚠️ Репозиторий {{ item.item }} может быть недоступен (статус: {{ item.status }})"
  loop: "{{ repo_check.results | default([]) }}"
  when:
    - system_check_repositories
    - item.status not in [200, 301, 302, 403]
  tags:
    - update
    - system
    - check

# ============================================
# ОБНОВЛЕНИЕ СИСТЕМЫ
# ============================================

- name: Проверка наличия обновлений
  apt:
    update_cache: true
    cache_valid_time: 3600
  register: apt_update
  changed_when: "'updated' in apt_update.cache_update_time or apt_update.cache_updated"
  when: system_update_enabled
  tags:
    - update
    - system

- name: Получение списка обновляемых пакетов
  command: apt list --upgradable
  register: upgradable_packages
  changed_when: false
  when: system_update_enabled
  tags:
    - update
    - system
    - check

- name: Получение количества обновляемых пакетов
  shell: apt list --upgradable 2>/dev/null | grep -v "Listing..." | wc -l
  register: upgradable_count
  changed_when: false
  when: system_show_upgrade_info
  tags:
    - update
    - system
    - check

- name: Отображение информации об обновлениях
  debug:
    msg:
      - "Доступно обновлений: {{ upgradable_count.stdout | default('0') }}"
      - "Список обновляемых пакетов:"
      - "{{ upgradable_packages.stdout_lines | default([]) }}"
  when:
    - system_update_enabled
    - system_show_upgrade_info
    - upgradable_packages.stdout_lines | length > 0
  tags:
    - update
    - system
    - check

- name: Обновление всех пакетов
  block:
    - name: Обновление всех пакетов
      apt:
        name: "*"
        state: latest
        update_cache: false
      register: apt_upgrade
  rescue:
    - name: Обработка ошибки обновления
      debug:
        msg: "⚠️ Ошибка при обновлении: {{ ansible_failed_result.msg | default('неизвестная ошибка') }}"
    - name: Попытка исправления сломанных пакетов
      command: dpkg --configure -a
      when: system_auto_fix_on_error
      register: dpkg_fix
    - name: Повторная попытка обновления после исправления
      apt:
        name: "*"
        state: latest
        update_cache: false
      register: apt_upgrade
      when:
        - system_auto_fix_on_error
        - dpkg_fix.rc == 0
    - name: Финальная ошибка обновления
      fail:
        msg: "Не удалось обновить пакеты. Проверьте логи и исправьте проблемы вручную."
      when:
        - not system_auto_fix_on_error
        - apt_upgrade is not defined or apt_upgrade.failed | default(true)
  when:
    - system_update_enabled
    - system_upgrade_packages
    - system_packages_to_update | length == 0
  tags:
    - update
    - system
    - upgrade

- name: Обновление конкретных пакетов
  apt:
    name: "{{ system_packages_to_update }}"
    state: latest
    update_cache: false
  register: apt_upgrade
  when:
    - system_update_enabled
    - system_upgrade_packages
    - system_packages_to_update | length > 0
  tags:
    - update
    - system
    - upgrade

- name: Обновление дистрибутива (dist-upgrade)
  apt:
    upgrade: dist
    update_cache: false
  register: apt_dist_upgrade
  when:
    - system_update_enabled
    - system_upgrade_distribution
  tags:
    - update
    - system
    - dist-upgrade

- name: Обновление только безопасности
  apt:
    upgrade: safe
    update_cache: false
    default_release: "{{ ansible_distribution_release }}-security"
  register: apt_security_upgrade
  when:
    - system_update_enabled
    - system_security_only
  tags:
    - update
    - system
    - security

- name: Закрепление пакетов (hold)
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop: "{{ system_hold_packages }}"
  when:
    - system_hold_packages | length > 0
  tags:
    - update
    - system
    - hold

- name: Удаление неиспользуемых пакетов
  apt:
    autoremove: true
    purge: true
  when:
    - system_update_enabled
    - system_autoremove
  tags:
    - update
    - system
    - autoremove

# ============================================
# ПРОВЕРКА ЦЕЛОСТНОСТИ ПОСЛЕ ОБНОВЛЕНИЯ
# ============================================

- name: Проверка целостности пакетов после обновления
  command: dpkg --audit
  register: dpkg_audit
  changed_when: false
  failed_when: false
  when:
    - system_update_enabled
    - system_check_package_integrity
  tags:
    - update
    - system
    - check
    - integrity

- name: Предупреждение о проблемах с пакетами
  debug:
    msg: "⚠️ Обнаружены проблемы с пакетами: {{ dpkg_audit.stdout }}"
  when:
    - system_update_enabled
    - system_check_package_integrity
    - dpkg_audit.rc != 0
    - dpkg_audit.stdout | length > 0
  tags:
    - update
    - system
    - check
    - integrity

- name: Проверка зависимостей apt
  command: apt-get check
  register: apt_check
  changed_when: false
  failed_when: false
  when:
    - system_update_enabled
    - system_check_package_integrity
  tags:
    - update
    - system
    - check
    - integrity

- name: Предупреждение о проблемах с зависимостями
  debug:
    msg: "⚠️ Обнаружены проблемы с зависимостями: {{ apt_check.stderr }}"
  when:
    - system_update_enabled
    - system_check_package_integrity
    - apt_check.rc != 0
    - apt_check.stderr | length > 0
  tags:
    - update
    - system
    - check
    - integrity

# ============================================
# ЛОГИРОВАНИЕ РЕЗУЛЬТАТОВ
# ============================================

- name: Создание директории для логов
  file:
    path: "{{ system_log_dir }}"
    state: directory
    mode: '0755'
  when:
    - system_log_updates
    - system_log_dir is defined
  tags:
    - update
    - system
    - log

- name: Сохранение списка обновленных пакетов
  copy:
    content: |
      Дата обновления: {{ ansible_date_time.iso8601 }}
      Хост: {{ ansible_hostname }}
      Дистрибутив: {{ ansible_distribution }} {{ ansible_distribution_version }}
      
      Обновленные пакеты:
      {% if apt_upgrade is defined and apt_upgrade.changed %}
      {% for package in apt_upgrade.changes | default({}) | dict2items %}
      - {{ package.key }}: {{ package.value.from }} -> {{ package.value.to }}
      {% endfor %}
      {% else %}
      Нет обновленных пакетов
      {% endif %}
      
      {% if apt_dist_upgrade is defined and apt_dist_upgrade.changed %}
      Выполнен dist-upgrade
      {% endif %}
      
      {% if apt_security_upgrade is defined and apt_security_upgrade.changed %}
      Выполнено обновление безопасности
      {% endif %}
    dest: "{{ system_log_dir }}/system-update-{{ ansible_date_time.epoch }}.log"
    mode: '0644'
  when:
    - system_log_updates
    - system_log_dir is defined
    - system_update_enabled
  tags:
    - update
    - system
    - log

- name: Очистка кэша apt
  apt:
    autoclean: true
    cache_valid_time: 0
  when:
    - system_update_enabled
    - system_clean_apt_cache
  tags:
    - update
    - system
    - clean

- name: Проверка обновления ядра
  stat:
    path: /var/run/reboot-required
  register: reboot_required_file
  tags:
    - update
    - system
    - check

- name: Проверка обновления ядра через файл
  stat:
    path: /var/run/reboot-required.pkgs
  register: reboot_required_packages
  tags:
    - update
    - system
    - check

- name: Отображение информации о необходимости перезагрузки
  debug:
    msg:
      - "Требуется перезагрузка: {{ reboot_required_file.stat.exists }}"
      - "Пакеты, требующие перезагрузки: {{ reboot_required_packages.stat.exists }}"
      - "Файл: {{ reboot_required_file.stat.path }}"
  when:
    - reboot_required_file.stat.exists
    - system_reboot_after_kernel_update
  tags:
    - update
    - system
    - reboot

- name: Отображение списка пакетов, требующих перезагрузки
  slurp:
    src: /var/run/reboot-required.pkgs
  register: reboot_packages_content
  when:
    - reboot_required_packages.stat.exists
    - system_reboot_after_kernel_update
  tags:
    - update
    - system
    - reboot

- name: Вывод списка пакетов для перезагрузки
  debug:
    msg: "Пакеты, требующие перезагрузки: {{ reboot_packages_content.content | b64decode | split('\n') }}"
  when:
    - reboot_packages_content.content is defined
    - system_reboot_after_kernel_update
  tags:
    - update
    - system
    - reboot

- name: Перезагрузка системы после обновления ядра
  reboot:
    msg: "Перезагрузка после обновления системы (ядра)"
    reboot_timeout: "{{ system_reboot_timeout }}"
    pre_reboot_delay: "{{ system_reboot_delay }}"
    post_reboot_delay: 30
    connect_timeout: 300
  when:
    - system_update_enabled
    - system_reboot_after_kernel_update
    - reboot_required_file.stat.exists
  tags:
    - update
    - system
    - reboot

# Автоматические обновления (unattended-upgrades)
# ВАЖНО: Выполняется только если system_unattended_upgrades: true
# По умолчанию ВЫКЛЮЧЕНО для безопасности
- name: Установка и настройка unattended-upgrades
  apt:
    name: unattended-upgrades
    state: present
  when:
    - system_update_enabled
    - system_unattended_upgrades
  tags:
    - update
    - system
    - unattended

- name: Установка источников обновлений для unattended-upgrades (Debian)
  set_fact:
    system_unattended_upgrades_origins:
      - "origin=Debian,codename={{ ansible_distribution_release }},label=Debian-Security"
      - "origin=Debian,codename={{ ansible_distribution_release }},label=Debian"
  when:
    - system_unattended_upgrades
    - ansible_distribution == "Debian"
    - system_unattended_upgrades_origins | length == 0
  tags:
    - update
    - system
    - unattended

- name: Установка источников обновлений для unattended-upgrades (Ubuntu)
  set_fact:
    system_unattended_upgrades_origins:
      - "origin=Ubuntu,codename={{ ansible_distribution_release }},label=Ubuntu"
      - "origin=Ubuntu,codename={{ ansible_distribution_release }},label=Ubuntu-Security"
  when:
    - system_unattended_upgrades
    - ansible_distribution == "Ubuntu"
    - system_unattended_upgrades_origins | length == 0
  tags:
    - update
    - system
    - unattended

- name: Настройка автоматических обновлений
  template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: '0644'
  notify: restart unattended-upgrades
  when:
    - system_update_enabled
    - system_unattended_upgrades
  tags:
    - update
    - system
    - unattended
